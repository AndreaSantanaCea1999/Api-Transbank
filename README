# üè¶ FERREMAS - Integraci√≥n Transbank Webpay Plus

<div align="center">

![Node.js](https://img.shields.io/badge/Node.js-18+-green.svg)
![Express](https://img.shields.io/badge/Express-4.21+-blue.svg)
![MySQL](https://img.shields.io/badge/MySQL-8.0+-orange.svg)
![Transbank](https://img.shields.io/badge/Transbank-Webpay%20Plus-red.svg)
![License](https://img.shields.io/badge/License-MIT-yellow.svg)

*Integraci√≥n completa con Transbank Webpay Plus para el sistema FERREMAS*

[Instalaci√≥n](#-instalaci√≥n) ‚Ä¢ [Configuraci√≥n](#-configuraci√≥n) ‚Ä¢ [API Docs](#-documentaci√≥n-de-api) ‚Ä¢ [Testing](#-testing) ‚Ä¢ [Producci√≥n](#-producci√≥n)

</div>

---

## üìã Tabla de Contenidos

- [üöÄ Caracter√≠sticas](#-caracter√≠sticas)
- [‚öôÔ∏è Instalaci√≥n](#Ô∏è-instalaci√≥n)
- [üîß Configuraci√≥n](#-configuraci√≥n)
- [üìÅ Estructura del Proyecto](#-estructura-del-proyecto)
- [üåê Documentaci√≥n de API](#-documentaci√≥n-de-api)
- [üîÑ Flujo de Transacciones](#-flujo-de-transacciones)
- [üíæ Base de Datos](#-base-de-datos)
- [üß™ Testing](#-testing)
- [üöÄ Producci√≥n](#-producci√≥n)
- [üõ†Ô∏è Troubleshooting](#Ô∏è-troubleshooting)
- [üìû Soporte](#-soporte)

---

## üöÄ Caracter√≠sticas

### ‚úÖ **Integraci√≥n Completa con Transbank**
- Conexi√≥n directa con API REST Webpay Plus (sin SDK)
- Soporte para ambientes de integraci√≥n y producci√≥n
- Manejo completo del flujo de pagos (crear, confirmar, consultar, reembolsar)
- Validaci√≥n autom√°tica de transacciones

### ‚úÖ **Sistema Integral FERREMAS**
- **API Inventario** (Puerto 3000): Gesti√≥n de productos y stock
- **API Banco** (Puerto 3001): Pagos y validaciones bancarias
- **API Transbank** (Puerto 3003): Orquestador de transacciones
- Sincronizaci√≥n autom√°tica entre todos los sistemas

### ‚úÖ **Caracter√≠sticas T√©cnicas**
- Base de datos MySQL con auditor√≠a completa
- Logs detallados de todas las operaciones
- Middleware de seguridad avanzado
- Rate limiting y validaci√≥n de entrada
- CORS configurado para m√∫ltiples or√≠genes
- Manejo robusto de errores

### ‚úÖ **Herramientas de Desarrollo**
- Suite de pruebas automatizada
- Colecci√≥n Postman incluida
- Scripts de migraci√≥n y setup
- Health checks para todas las APIs
- Panel de administraci√≥n para transacciones

---

## ‚öôÔ∏è Instalaci√≥n

### **Prerrequisitos**
- **Node.js** 18.0.0 o superior
- **MySQL** 8.0 o superior
- **npm** 8.0.0 o superior

### **1. Clonar el Repositorio**
```bash
git clone https://github.com/tu-usuario/ferremas-transbank.git
cd ferremas-transbank
```

### **2. Instalar Dependencias**
```bash
npm install
```

### **3. Configurar Base de Datos**
```bash
# Crear la base de datos
mysql -u root -p -e "CREATE DATABASE ferremas_complete CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"

# Ejecutar scripts de configuraci√≥n
mysql -u administrador -p ferremas_complete < scripts/setup-database.sql
```

### **4. Configurar Variables de Entorno**
```bash
# Copiar archivo de ejemplo
cp .env.example .env

# Editar configuraci√≥n
nano .env
```

### **5. Iniciar el Servidor**
```bash
# Desarrollo
npm run dev

# Producci√≥n
npm start
```

---

## üîß Configuraci√≥n

### **Variables de Entorno Cr√≠ticas**

```bash
# ============================================
# CONFIGURACI√ìN WEBPAY PLUS - FERREMAS
# ============================================

# Ambiente Webpay
WEBPAY_ENV=integration  # o 'production' para producci√≥n

# Credenciales Transbank (Integraci√≥n)
WEBPAY_API_KEY_ID=597055555532
WEBPAY_API_KEY_SECRET=579B532A7440BB0C9079DED94D31EA1615BACEB56610332264630D42D0A36B1C

# Base de datos
DB_HOST=localhost
DB_USER=administrador
DB_PASSWORD=yR!9uL2@pX
DB_NAME=ferremas_complete
DB_PORT=3306

# URLs de APIs internas
API_INVENTARIO_URL=http://localhost:3000/api
API_BANCO_URL=http://localhost:3001/api/v1

# Puerto de la API
PORT=3003

# CORS y or√≠genes permitidos
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:3003
```

### **Configuraci√≥n para Producci√≥n**

‚ö†Ô∏è **Para producci√≥n, reemplazar con credenciales reales:**

```bash
WEBPAY_ENV=production
WEBPAY_API_KEY_ID=tu_api_key_id_real
WEBPAY_API_KEY_SECRET=tu_api_key_secret_real
```

---

## üìÅ Estructura del Proyecto

```
ferremas-transbank/
‚îú‚îÄ‚îÄ üìÑ app.js                          # Aplicaci√≥n principal Express
‚îú‚îÄ‚îÄ üìÇ src/
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transbankController.js      # Controlador principal Transbank
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webpayController.js         # Controlador Webpay Plus real
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ models/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Transaccion.js              # Modelo de transacciones
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TransbankLog.js             # Modelo de logs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js                    # Configuraci√≥n Sequelize
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transbankRoutes.js          # Rutas principales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webpayRoutes.js             # Rutas Webpay real
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ middlewares/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ security.js                 # Middleware de seguridad
‚îÇ   ‚îú‚îÄ‚îÄ üìÇ utils/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ webpayHelpers.js            # Utilidades Webpay
‚îÇ   ‚îî‚îÄ‚îÄ üìÇ config/
‚îÇ       ‚îú‚îÄ‚îÄ database.js                 # Configuraci√≥n BD
‚îÇ       ‚îî‚îÄ‚îÄ webpay.js                   # Configuraci√≥n Webpay
‚îú‚îÄ‚îÄ üìÇ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ setup-database.sql              # Script setup BD
‚îÇ   ‚îú‚îÄ‚îÄ test-integration.js             # Tests integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ test-webpay-integration.js      # Tests Webpay
‚îÇ   ‚îî‚îÄ‚îÄ migrate-to-real-webpay.js       # Script migraci√≥n
‚îú‚îÄ‚îÄ üìÇ docs/
‚îÇ   ‚îî‚îÄ‚îÄ FERREMAS_API_Collection.postman.yaml  # Colecci√≥n Postman
‚îú‚îÄ‚îÄ üìÑ package.json
‚îú‚îÄ‚îÄ üìÑ .env.example
‚îî‚îÄ‚îÄ üìÑ README.md
```

---

## üåê Documentaci√≥n de API

### **Base URL**
```
http://localhost:3003/api/transbank
```

### **üè• Health Checks**

#### **Verificar Estado General**
```http
GET /api/transbank/health
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Todas las conexiones funcionando",
  "status": "API Transbank funcionando",
  "version": "1.0.0",
  "conexiones": {
    "inventario": true,
    "banco": true,
    "database": true,
    "timestamp": "2025-06-28T10:30:00.000Z"
  }
}
```

### **üí≥ Gesti√≥n de Transacciones**

#### **Crear Nueva Transacci√≥n**
```http
POST /api/transbank/iniciar
Content-Type: application/json
```

**Body:**
```json
{
  "clienteId": 1,
  "ordenCompra": "ORD-1234567890",
  "monto": 75000,
  "divisa": "CLP",
  "detalles": [
    {
      "ID_Producto": 1,
      "Cantidad": 2,
      "Precio_Unitario": 25000
    },
    {
      "ID_Producto": 2,
      "Cantidad": 1,
      "Precio_Unitario": 25000
    }
  ]
}
```

**Respuesta Exitosa:**
```json
{
  "success": true,
  "message": "Transacci√≥n creada exitosamente",
  "transaccion": {
    "id": 123,
    "cliente_id": 1,
    "orden_compra": "ORD-1234567890",
    "monto": 75000,
    "estado": "PENDIENTE",
    "token": "e9d555262db0f989e49d724b4db0bd681def....",
    "fecha_creacion": "2025-06-28T10:30:00.000Z"
  }
}
```

#### **Confirmar Transacci√≥n**
```http
POST /api/transbank/confirmar
Content-Type: application/json
```

**Body:**
```json
{
  "id_transaccion": 123
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Transacci√≥n confirmada exitosamente",
  "transaccion": {
    "id": 123,
    "estado": "APROBADO",
    "fecha_actualizacion": "2025-06-28T10:35:00.000Z"
  },
  "data": {
    "pago_registrado": true,
    "pedido_creado": true,
    "inventario_actualizado": true
  }
}
```

#### **Consultar Estado de Transacci√≥n**
```http
GET /api/transbank/estado/{id_transaccion}
```

**Respuesta:**
```json
{
  "success": true,
  "transaccion": {
    "id": 123,
    "cliente_id": 1,
    "orden_compra": "ORD-1234567890",
    "monto": 75000,
    "estado": "APROBADO",
    "detalles": [...],
    "fecha_creacion": "2025-06-28T10:30:00.000Z",
    "fecha_actualizacion": "2025-06-28T10:35:00.000Z"
  }
}
```

#### **Listar Transacciones**
```http
GET /api/transbank/listar?limit=10&estado=APROBADO&cliente_id=1
```

### **üîÑ Webpay Plus Real**

#### **Crear Transacci√≥n Webpay**
```http
POST /api/webpay/create
Content-Type: application/json
```

**Body:**
```json
{
  "clienteId": 1,
  "productos": [
    {"ID_Producto": 1, "Cantidad": 2},
    {"ID_Producto": 2, "Cantidad": 1}
  ],
  "returnUrl": "https://mi-sitio.com/webpay/return"
}
```

**Respuesta:**
```json
{
  "success": true,
  "message": "Transacci√≥n creada exitosamente en Transbank",
  "data": {
    "token": "e9d555262db0f989e49d724b4db0bd681def....",
    "url": "https://webpay3gint.transbank.cl/webpayserver/initTransaction",
    "transaccion_id": 123,
    "amount": 50000
  },
  "instructions": {
    "next_step": "Redirigir usuario a result.data.url con form POST",
    "form_data": {
      "token_ws": "e9d555262db0f989e49d724b4db0bd681def...."
    }
  }
}
```

#### **Confirmar Transacci√≥n Webpay**
```http
PUT /api/webpay/confirm/{token}
```

### **üìä Administraci√≥n y Consultas**

#### **Obtener Estad√≠sticas**
```http
GET /api/transbank/stats
```

#### **Consultar Logs**
```http
GET /api/transbank/logs?limit=20&accion=CONFIRMAR_TRANSACCION
```

---

## üîÑ Flujo de Transacciones

### **Flujo Completo de Pago**

```mermaid
sequenceDiagram
    participant C as Cliente
    participant F as Frontend
    participant T as API Transbank
    participant I as API Inventario
    participant B as API Banco
    participant W as Webpay Plus
    participant D as Base de Datos

    C->>F: Iniciar compra
    F->>T: POST /api/transbank/iniciar
    T->>I: Validar productos y stock
    I-->>T: Stock disponible
    T->>D: Crear transacci√≥n
    T->>W: Crear transacci√≥n Webpay
    W-->>T: Token + URL
    T-->>F: Token para pago
    
    F->>W: Redirigir a Webpay
    C->>W: Realizar pago
    W->>T: Webhook confirmaci√≥n
    T->>W: Confirmar transacci√≥n
    W-->>T: Resultado final
    
    alt Pago Exitoso
        T->>B: Registrar pago
        T->>I: Actualizar inventario
        T->>D: Actualizar estado
        T-->>F: Confirmaci√≥n exitosa
    else Pago Fallido
        T->>D: Marcar como fallido
        T-->>F: Error de pago
    end
```

### **Estados de Transacci√≥n**

| Estado | Descripci√≥n | Es Final |
|--------|-------------|----------|
| `PENDIENTE` | Transacci√≥n creada, esperando pago | ‚ùå |
| `PROCESANDO` | Pago en proceso de validaci√≥n | ‚ùå |
| `APROBADO` | Pago aprobado exitosamente | ‚úÖ |
| `RECHAZADO` | Pago rechazado o fallido | ‚úÖ |
| `CANCELADO` | Transacci√≥n cancelada | ‚úÖ |
| `REEMBOLSADO` | Transacci√≥n reembolsada | ‚úÖ |
| `EXPIRADO` | Transacci√≥n expirada por tiempo | ‚úÖ |

---

## üíæ Base de Datos

### **Tabla Principal: `transacciones`**
```sql
CREATE TABLE transacciones (
    id INT AUTO_INCREMENT PRIMARY KEY,
    ID_Cliente INT NULL,
    ordenCompra VARCHAR(100) NULL,
    monto DECIMAL(10,2) NULL,
    token VARCHAR(255) NULL,
    estado VARCHAR(50) DEFAULT 'PENDIENTE',
    detalles LONGTEXT NULL,
    createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### **Tabla de Logs: `transbank_logs`**
```sql
CREATE TABLE transbank_logs (
    ID_Log INT AUTO_INCREMENT PRIMARY KEY,
    ID_Transaccion INT NULL,
    Accion VARCHAR(50) NOT NULL,
    Descripcion VARCHAR(500) NULL,
    Datos_Entrada TEXT NULL,
    Datos_Salida TEXT NULL,
    Codigo_Respuesta VARCHAR(10) DEFAULT '200',
    Mensaje_Error TEXT NULL,
    IP_Origen VARCHAR(45) NULL,
    User_Agent TEXT NULL,
    Duracion_MS INT DEFAULT 0,
    Fecha_Creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## üß™ Testing

### **Ejecutar Suite Completa de Pruebas**
```bash
# Pruebas de integraci√≥n completa
node scripts/test-integration.js

# Pruebas espec√≠ficas de Webpay
node scripts/test-webpay-integration.js

# Prueba r√°pida
node scripts/test-webpay-integration.js --quick
```

### **Health Checks Manuales**
```bash
# Verificar APIs
curl http://localhost:3003/api/transbank/health
curl http://localhost:3003/api/webpay/health

# Crear transacci√≥n de prueba
curl -X POST http://localhost:3003/api/webpay/test-create
```

### **Datos de Prueba (Ambiente Integraci√≥n)**
- **Tarjeta de Prueba:** `4051885600446623`
- **CVV:** `123`
- **Fecha:** Cualquier fecha futura (ej: `12/25`)
- **Resultado:** Transacci√≥n aprobada

### **Colecci√≥n Postman**
Importa la colecci√≥n incluida en `docs/FERREMAS_API_Collection.postman.yaml` para probar todos los endpoints.

**Flujo de prueba recomendado:**
1. Health Checks ‚Üí Verificar APIs
2. Listar Productos ‚Üí Consultar inventario
3. Crear Transacci√≥n ‚Üí Flujo completo
4. Confirmar Transacci√≥n ‚Üí Procesar pago
5. Verificar Estado ‚Üí Validar resultado

---

## üöÄ Producci√≥n

### **1. Configuraci√≥n de Ambiente**
```bash
# Variables cr√≠ticas para producci√≥n
NODE_ENV=production
WEBPAY_ENV=production

# Credenciales reales de Transbank
WEBPAY_API_KEY_ID=tu_api_key_id_real
WEBPAY_API_KEY_SECRET=tu_api_key_secret_real

# URLs de producci√≥n
API_INVENTARIO_URL=https://tu-api-inventario-prod.com
API_BANCO_URL=https://tu-api-banco-prod.com
```

### **2. Requisitos de Infraestructura**
- **HTTPS obligatorio** (Transbank requiere SSL)
- **MySQL 8.0+** con configuraci√≥n optimizada
- **Node.js 18+** con PM2 para gesti√≥n de procesos
- **Nginx/Apache** como proxy reverso
- **Monitoring** y alertas configuradas

### **3. Optimizaciones de Base de Datos**
```sql
-- √çndices para mejor rendimiento
CREATE INDEX idx_transacciones_estado ON transacciones(estado);
CREATE INDEX idx_transacciones_fecha ON transacciones(createdAt);
CREATE INDEX idx_logs_transaccion ON transbank_logs(ID_Transaccion);
CREATE INDEX idx_logs_fecha ON transbank_logs(Fecha_Creacion);

-- Configurar limpieza autom√°tica
-- Ejecutar semanalmente
DELETE FROM transbank_logs WHERE Fecha_Creacion < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### **4. Comandos de Despliegue**
```bash
# Instalar dependencias de producci√≥n
npm ci --only=production

# Iniciar con PM2
pm2 start app.js --name "ferremas-transbank"
pm2 startup
pm2 save

# Logs en tiempo real
pm2 logs ferremas-transbank
```

---

## üõ†Ô∏è Troubleshooting

### **Problemas Comunes**

#### **‚ùå Error: "ECONNREFUSED" al conectar con APIs**
```bash
# Verificar que las APIs est√©n corriendo
curl http://localhost:3000/api/productos  # API Inventario
curl http://localhost:3001/api/v1/        # API Banco

# Verificar variables de entorno
echo $API_INVENTARIO_URL
echo $API_BANCO_URL
```

#### **‚ùå Error: "ER_ACCESS_DENIED_ERROR" Base de Datos**
```bash
# Verificar credenciales
mysql -u administrador -p -h localhost

# Verificar permisos
GRANT ALL PRIVILEGES ON ferremas_complete.* TO 'administrador'@'localhost';
FLUSH PRIVILEGES;
```

#### **‚ùå Error: "Invalid API Key" Transbank**
```bash
# Verificar credenciales en .env
echo $WEBPAY_API_KEY_ID
echo $WEBPAY_API_KEY_SECRET

# Para producci√≥n, usar credenciales reales
# Para testing, usar: 597055555532 y 579B532A7440BB0C9079DED94D31EA1615BACEB56610332264630D42D0A36B1C
```

#### **‚ùå Error: "CORS Policy" Frontend**
```bash
# Verificar configuraci√≥n CORS
echo $ALLOWED_ORIGINS

# Debe incluir la URL del frontend
ALLOWED_ORIGINS=http://localhost:3000,http://localhost:3001,http://localhost:3003,http://localhost:3004
```

### **Logs y Debugging**
```bash
# Logs detallados
TRANSBANK_DEBUG=true
LOG_LEVEL=debug

# Ver logs de base de datos
SELECT * FROM transbank_logs ORDER BY Fecha_Creacion DESC LIMIT 10;

# Ver transacciones recientes
SELECT * FROM transacciones ORDER BY createdAt DESC LIMIT 10;
```

---

## üìû Soporte

### **Recursos de Desarrollo**
- **Documentaci√≥n Oficial Transbank:** [https://www.transbankdevelopers.cl/](https://www.transbankdevelopers.cl/)
- **API REST Webpay Plus:** [https://www.transbankdevelopers.cl/documentacion/webpay-plus](https://www.transbankdevelopers.cl/documentacion/webpay-plus)
- **Postman Collection:** `docs/FERREMAS_API_Collection.postman.yaml`

### **Scripts de Utilidad**
```bash
# Verificar configuraci√≥n completa
node scripts/verify-setup.js

# Migrar a Webpay real
node scripts/migrate-to-real-webpay.js

# Setup autom√°tico completo
node scripts/setup-webpay-complete.js
```

### **Contacto y Contribuciones**
- **Issues:** Reportar problemas en el repositorio
- **Wiki:** Documentaci√≥n extendida disponible
- **Slack/Teams:** Canal de desarrollo interno

### **Informaci√≥n de Versi√≥n**
- **Versi√≥n Actual:** 2.0.0
- **Node.js:** 18.0.0+
- **Express:** 4.21.2
- **MySQL:** 8.0+
- **√öltima Actualizaci√≥n:** Junio 2025

---

<div align="center">

**üè™ FERREMAS - Sistema de Pagos Transbank**

*Desarrollado con ‚ù§Ô∏è para el ecosistema FERREMAS*

![FERREMAS](https://img.shields.io/badge/FERREMAS-Transbank%20Integration-blue.svg)

</div>
